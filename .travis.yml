language: bash
dist: trusty
sudo: false

addons:
  apt:
    sources:
    - debian-sid
    packages:
    - python-docutils
    - shellcheck

env:
  - DIST=regular DEPLOY_FILE=butt-*.tar.gz
  - DIST=single DEPLOY_FILE=butt.sh

before_install:
  - export PREFIX=$HOME/opt
  - mkdir -p $PREFIX/bin
  - export PATH=$PREFIX/bin:$PATH

before_script:
  - |
    if [[ $DIST == regular ]]; then
      ./configure \
        && make \
        && cat compiled/install \
        && compiled/install \
        && PREFIX=/usr/local make dist
    fi
  - |
    if [[ $DIST == single ]]; then
      ./configure \
        && make distsingle \
        && cp butt.sh $PREFIX/bin/butt
    fi

script:
  - shellcheck butt
  - butt -w test test/test.butt

deploy:
  - provider: releases
    api_key: "$GITHUB_TOKEN"
    file: "$DEPLOY_FILE"
    skip_cleanup: true
    file_glob: true
    on:
      repo: InternetGuru/butt
      tags: true
  - deploy:
    provider: script
    script: "scripts/changelog-latest CHANGELOG.md | scripts/travis-update-release"
    on:
      repo: InternetGuru/butt
      tags: true

matrix:
  fast_finish: true
